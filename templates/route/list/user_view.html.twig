{% extends 'base.html.twig' %}

{% block title %}Explorar Rutas{% endblock %}

{% block body_class %}explore-page{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/pages/route/list/user_view.css') }}">
{% endblock %}

{% block content %}
    <!-- Contenedor principal con fondo de patrón -->
    <div class="explore-wrapper">
        <!-- Encabezado con espacio para la navegación -->
        <div class="explore-header">
            <div class="container">
                <h1 class="page-title">Explorar Rutas de Escalada</h1>
                <p class="page-subtitle">Descubre las mejores rutas para tu próxima aventura</p>
            </div>
        </div>

        <div class="container py-4">
            <!-- Filtro de búsqueda -->
            <div class="filter-container">
                <form method="get" class="filter-form">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" name="name" class="form-control" placeholder="Buscar por nombre..."
                                       value="{{ app.request.query.get('name', '') }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-mountain"></i></span>
                                <select name="route_type" class="form-select">
                                    <option value="">Todos los tipos</option>
                                    <option value="Sport" {% if app.request.query.get('route_type') == 'Sport' %}selected{% endif %}>
                                        Sport
                                    </option>
                                    <option value="Trad" {% if app.request.query.get('route_type') == 'Trad' %}selected{% endif %}>
                                        Trad
                                    </option>
                                    <option value="Boulder"
                                            {% if app.request.query.get('route_type') == 'Boulder' %}selected{% endif %}>Boulder
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-star"></i></span>
                                <input type="text" name="difficulty" class="form-control" placeholder="Dificultad..."
                                       value="{{ app.request.query.get('difficulty', '') }}">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Filtrar rutas -->
            {% set filtered_routes = routes|filter(route =>
                (not app.request.query.get('name') or route.name matches '/.*' ~ app.request.query.get('name') ~ '.*/i') and
                (not app.request.query.get('route_type') or route.routeType.value == app.request.query.get('route_type')) and
                (not app.request.query.get('difficulty') or route.difficulty matches '/.*' ~ app.request.query.get('difficulty') ~ '.*/i')
                ) %}

            <!-- Paginación -->
            {% set page = app.request.query.get('page', 1) %}
            {% set per_page = app.request.query.get('per_page', 30) %}
            {% set total_routes = filtered_routes|length %}
            {% set total_pages = (total_routes / per_page)|round(0, 'ceil') %}
            {% set paginated_routes = filtered_routes|slice((page - 1) * per_page, per_page) %}

            <!-- Resultados y estadísticas -->
            <div class="results-stats">
                <div class="results-count">
                    <i class="fas fa-route me-2"></i>
                    <span>{{ total_routes }} rutas encontradas</span>
                </div>
                <div class="view-options">
                    <button class="view-btn active" data-view="grid">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="view-btn" data-view="list">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            {% if paginated_routes|length > 0 %}
                <div class="routes-container grid-view">
                    {% for route in paginated_routes %}
                        <div class="route-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 50 }}">
                            <div class="route-card-header">
                                <div class="route-type-badge {{ route.routeType.value|lower }}">{{ route.routeType.value }}</div>
                                <h2 class="route-name">{{ route.name }}</h2>
                                <div class="route-difficulty">{{ route.difficulty }}</div>
                            </div>
                            <div class="route-card-body">
                                <div class="route-detail">
                                    <div class="detail-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">Ubicación</div>
                                        <div class="detail-value">{{ route.location.name }}</div>
                                    </div>
                                </div>

                                <div class="route-detail">
                                    <div class="detail-icon">
                                        <i class="fas fa-ruler-vertical"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">Longitud</div>
                                        <div class="detail-value">{{ route.length }} metros</div>
                                    </div>
                                </div>

                                <div class="route-detail">
                                    <div class="detail-icon">
                                        <i class="fas fa-layer-group"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">Largos</div>
                                        <div class="detail-value">{{ route.pitches }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="route-card-footer">
                                <a href="#" class="btn btn-outline-primary btn-sm view-details-btn">
                                    <i class="fas fa-info-circle me-1"></i>Ver detalles
                                </a>
                                {% if app.user %}
                                    <button class="btn btn-primary btn-sm save-route-btn" data-route-id="{{ route.id }}">
                                        <i class="fas fa-bookmark me-1"></i>Guardar
                                    </button>
                                {% endif %}
                            </div>
                            <div class="success-message">
                                <i class="fas fa-check-circle me-2"></i>¡Ruta guardada!
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Paginación mejorada -->
                {% set maxVisiblePages = app.request.query.get('mobile', false) ? 5 : 7 %}
                {% set range = (maxVisiblePages / 2)|round(0, 'floor') %}
                {% set start = (page - range) > 1 ? (page - range) : 1 %}
                {% set end = (start + maxVisiblePages - 1) < total_pages ? (start + maxVisiblePages - 1) : total_pages %}

                <div class="pagination-container">
                    <nav aria-label="Navegación de páginas">
                        <ul class="pagination">
                            {% if page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': 1})) }}" aria-label="Primera">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': page - 1})) }}" aria-label="Anterior">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}

                            {% if start > 1 %}
                                <li class="page-item d-none d-md-block">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': 1})) }}">1</a>
                                </li>
                                {% if start > 2 %}
                                    <li class="page-item disabled d-none d-md-block"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endif %}

                            {% for p in start..end %}
                                <li class="page-item {% if p == page %}active{% endif %} {% if loop.index > 5 %}d-none d-md-block{% endif %}">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': p})) }}">{{ p }}</a>
                                </li>
                            {% endfor %}

                            {% if end < total_pages %}
                                {% if end < total_pages - 1 %}
                                    <li class="page-item disabled d-none d-md-block"><span class="page-link">...</span></li>
                                {% endif %}
                                <li class="page-item d-none d-md-block">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': total_pages})) }}">{{ total_pages }}</a>
                                </li>
                            {% endif %}

                            {% if page < total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': page + 1})) }}" aria-label="Siguiente">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="{{ path(app.request.get('_route'), app.request.query.all|merge({'page': total_pages})) }}" aria-label="Última">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    <div class="page-info">
                        Página {{ page }} de {{ total_pages }}
                    </div>
                </div>

            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <h3 class="empty-state-title">No hay rutas disponibles</h3>
                    <p class="empty-state-text">No se encontraron rutas que coincidan con tus criterios de búsqueda.</p>
                    <a href="{{ path(app.request.get('_route')) }}" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Reiniciar filtros
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="routes-data"
         data-check-completed="{{ path('app_check_completed_route') }}"
         data-check-saved="{{ path('app_check_saved_route') }}"
         data-save-route="{{ path('app_save_route') }}">
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/user_view/pagination_completed_saved_routes.js') }}"></script>
    <script src="{{ asset('js/user_view/view_toggle.js') }}"></script>
{% endblock %}